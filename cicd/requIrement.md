# 需求文档: GitOps CI/CD 后台系统

## 1. 愿景 (Vision)

构建一个无头 (Headless)、事件驱动的 CI/CD 系统。该系统以 Git 仓库作为所有配置的唯一真实来源 (Single Source of Truth)，通过 Webhook 与任意 Git 托管平台（如 GitHub, Gitea, GitLab 等）集成，为开发人员提供一个透明、高效、可复现的自动化工作流引擎。

## 2. 核心原则 (Core Principles)

*   **配置即代码 (Configuration as Code):** 所有的 CI/CD 流水线、环境、变量和秘钥引用都定义在 Git 仓库内的 YAML 文件中。
*   **GitOps 驱动:** Git 的 `push` 和 `pull_request` 等事件是触发所有自动化流程的唯一入口。
*   **无主界面 (Headless Operation):** 系统本身不提供面向开发者的图形用户界面。所有的交互和状态反馈都通过 Git 平台（如 Commit Status, Pull Request Checks）完成。
*   **环境隔离:** 每个 CI/CD 任务都在一个干净、隔离的容器环境中运行，确保构建的可复现性。
*   **关注点分离 (Separation of Concerns):**
    *   **开发者 (Developer):** 关注业务代码和工作流逻辑的编排 (`ci.yaml`)。
    *   **管理员 (Administrator):** 关注底层物理资源的管理、系统安全和秘钥配置。

## 3. 用户画像 (User Personas)

*   **开发者 (Developer):**
    *   **目标:** 快速获得代码提交的反馈（测试是否通过、构建是否成功），并自动化部署流程。
    *   **痛点:** 不希望学习和登录一个新的、复杂的 CI/CD 系统平台，希望所有操作都能在熟悉的 Git 环境中完成。
*   **系统管理员 / DevOps 工程师 (Administrator):**
    *   **目标:** 为团队提供一个稳定、安全、资源可控的 CI/CD 平台。
    *   **痛点:** 需要对计算资源进行统一管理和分配，确保敏感信息（如生产秘钥）不被泄露。

## 4. 用户故事 (User Stories)

### 面向开发者

*   **US-D01: 连接仓库**
    *   **作为** 一名开发者，**我想要** 能够通过在我的 Git 仓库设置中添加一个 Webhook URL 和 Secret，**以便** 将我的仓库连接到 CI/CD 系统。

*   **US-D02: 定义工作流**
    *   **作为** 一名开发者，**我想要** 能够在我的仓库根目录下创建一个 `ci.yaml` 文件，**以便** 用代码来定义我的 CI/CD 工作流。

*   **US-D03: Push 触发**
    *   **作为** 一名开发者，**我想要** 在我向指定分支（如 `main`）`push` 代码时，**以便** 自动触发 `ci.yaml` 中定义的 CI/CD 流程。

*   **US-D04: PR 触发**
    *   **作为** 一名开发者，**我想要** 在我创建或更新一个 Pull Request 时，**以便** 自动触发 `ci.yaml` 中定义的测试和检查流程。

*   **US-D05: 查看结果**
    *   **作为** 一名开发者，**我想要** 直接在 Git 平台的 Commit 或 Pull Request 页面上看到 CI/CD 流程的运行状态（如 `pending`, `success`, `failure`），**以便** 快速了解我的代码变更是否引入了问题。

*   **US-D06: 指定运行系统环境**
    *   **作为** 一名开发者，**我想要** 能够在 `ci.yaml` 的每个任务中指定一个 Docker 镜像（如 `node:18` 或 `golang:1.19`），**以便** 在一个确定的操作系统和工具链环境中执行我的脚本。

*   **US-D07: 指定运行物理环境**
    *   **作为** 一名开发者，**我想要** 能够从一个预定义的别名列表（如 `small`, `medium`, `large`）中选择一个来指定任务的计算资源，**以便** 为不同类型的任务（如 lint vs. 编译）分配合理的 CPU 和内存。

*   **US-D08: 使用环境变量**
    *   **作为** 一名开发者，**我想要** 能够在 `ci.yaml` 中定义环境变量，**以便** 将非敏感的配置信息传递给我的构建和测试脚本。

*   **US-D09: 使用敏感信息**
    *   **作为** 一名开发者，**我想要** 能够在 `ci.yaml` 中通过名称引用预先配置好的秘钥（Secrets），**以便** 在脚本中安全地使用 API Token、数据库密码等敏感信息，而无需将它们硬编码在代码库中。

*   **US-D10: 定时触发**
    *   **作为** 一名开发者，**我想要** 能够在 `ci.yaml` 中定义 [Cron](https://www.google.com/search?q=Cron+job) 表达式，**以便** 触发定时任务，例如每日构建或夜间集成测试。

### 面向管理员

*   **US-A01: 管理物理资源**
    *   **作为** 一名管理员，**我想要** 能够通过一个中心化的配置文件或 API 来定义物理资源别名（如 `small`, `medium`）及其对应的 CPU 和内存规格，**以便** 统一管理和控制整个系统的资源分配。

*   **US-A02: 管理秘钥**
    *   **作为** 一名管理员，**我想要** 能够通过安全的 API 或命令行工具，为指定的仓库或组织添加、更新和删除秘钥，**以便** 开发者可以在工作流中按名称引用这些秘钥。

*   **US-A03: 保证 Webhook 安全**
    *   **作为** 一名管理员，**我想要** 系统能够验证每一个传入的 Webhook 请求的 Secret Token，**以便** 确保只有合法的 Git 平台才能触发 CI/CD 流程。